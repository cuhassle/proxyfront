<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VS Browser for Webview</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #121212;
      color: white;
      margin: 0;
    }
    input, button {
      padding: 10px;
      margin-top: 10px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
    }
    button {
      background-color: #007acc;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
      width: 100%;
    }
    button:hover {
      background-color: #005fa3;
    }
    .error {
      color: #ff4b4b;
      margin-top: 10px;
      height: 20px;
    }
    #browserContainer {
      display: block;
      width: 100vw;
      height: 100vh;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      flex-direction: column;
      overflow: hidden;
      background: #1e1e1e;
    }
    .toolbar {
      display: flex;
      align-items: center;
      padding: 6px;
      background: #252526;
      border-bottom: 1px solid #333;
    }
    .nav-buttons {
      display: flex;
      margin-right: 8px;
    }
    .nav-button {
      margin-right: 4px;
      padding: 6px 10px;
      border-radius: 3px;
      background: #3c3c3c;
      color: white;
      cursor: pointer;
    }
    .nav-button:hover {
      background: #555;
    }
    .address-bar {
      flex: 1;
    }
    #addressBar {
      width: 100%;
      padding: 6px;
      border-radius: 3px;
      border: none;
      outline: none;
      background: #1e1e1e;
      color: white;
      font-size: 14px;
    }
    .tab-bar {
      display: flex;
      align-items: center;
      background: #2d2d2d;
      padding: 4px;
      border-bottom: 1px solid #333;
    }
    .tabs-container {
      display: flex;
      flex: 1;
      overflow-x: auto;
    }
    .tab {
      padding: 6px 10px;
      background: #3c3c3c;
      margin-right: 4px;
      border-radius: 3px 3px 0 0;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .tab.active {
      background: #007acc;
    }
    .tab span {
      margin-right: 6px;
      font-size: 14px;
    }
    .tab-close {
      background: transparent;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    .new-tab {
      background: #007acc;
      border: none;
      padding: 6px 10px;
      border-radius: 3px;
      color: white;
      cursor: pointer;
    }
    .new-tab:hover {
      background: #005fa3;
    }
    .webview-container {
      flex: 1;
      height: calc(100% - 90px);
      position: relative;
    }
    .webview {
      width: 100%;
      height: 100%;
      border: none;
      display: none;
      background: white;
    }
    .webview.active {
      display: block;
    }
    .loading-indicator {
      display: none;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007acc;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .status-bar {
      background: #252526;
      padding: 4px 8px;
      font-size: 12px;
      color: #ccc;
      border-top: 1px solid #333;
    }
  </style>
</head>
<body>
  <div id="browserContainer">
    <div class="toolbar">
      <div class="nav-buttons">
        <button id="backBtn" class="nav-button" title="Back">←</button>
        <button id="forwardBtn" class="nav-button" title="Forward">→</button>
        <button id="refreshBtn" class="nav-button" title="Refresh">↻</button>
      </div>
      <div class="address-bar">
        <input type="text" id="addressBar" placeholder="Enter URL or search term">
      </div>
      <button id="goBtn" class="nav-button" title="Go">Go</button>
    </div>

    <div class="tab-bar">
      <div class="tabs-container" id="tabsContainer"></div>
      <button id="newTabBtn" class="new-tab" title="New Tab">+</button>
    </div>

    <div class="webview-container" id="webviewContainer">
      <div class="loading-indicator" id="loadingIndicator">
        <div class="spinner"></div>
      </div>
    </div>

    <div class="status-bar" id="statusBar">Ready</div>
  </div>

  <!-- Ultraviolet scripts -->
  <script src="/active/uv/uv.bundle.js" defer></script>
  <script src="/active/uv/uv.config.js" defer></script>
  <script src="/assets/js/register.js" defer></script>

  <script>
    const HOMEPAGE = 'https://duckduckgo.com';
    let tabs = [];
    let activeTabId = null;
    let tabCounter = 0;
    const tabHistories = new Map();

    const tabsContainer = document.getElementById('tabsContainer');
    const webviewContainer = document.getElementById('webviewContainer');
    const newTabBtn = document.getElementById('newTabBtn');
    const addressBar = document.getElementById('addressBar');
    const backBtn = document.getElementById('backBtn');
    const forwardBtn = document.getElementById('forwardBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const goBtn = document.getElementById('goBtn');
    const statusBar = document.getElementById('statusBar');
    const loadingIndicator = document.getElementById('loadingIndicator');

    function encodeUrl(input) {
      if (!input) return '';
      if (!input.startsWith('http://') && !input.startsWith('https://')) {
        if (input.includes(' ') || !input.includes('.')) {
          input = `https://duckduckgo.com/?q=${encodeURIComponent(input)}`;
        } else {
          input = 'https://' + input;
        }
      }
      return __uv$config.prefix + __uv$config.encodeUrl(input);
    }

    function init() {
      setupEventListeners();
      createNewTab(HOMEPAGE);
    }

    function setupEventListeners() {
      newTabBtn.addEventListener('click', () => createNewTab());
      backBtn.addEventListener('click', () => navigateHistory(-1));
      forwardBtn.addEventListener('click', () => navigateHistory(1));
      refreshBtn.addEventListener('click', () => {
        const tab = getActiveTab();
        if (tab) navigateToUrl(tab.url, tab);
      });
      addressBar.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const tab = getActiveTab();
          if (tab) navigateToUrl(addressBar.value, tab);
        }
      });
      goBtn.addEventListener('click', () => {
        const tab = getActiveTab();
        if (tab) navigateToUrl(addressBar.value, tab);
      });
    }

    function createNewTab(url = '') {
      const tabId = `tab-${++tabCounter}`;
      const tab = { id: tabId, url: '', title: 'New Tab', iframe: null };
      tabs.push(tab);
      tabHistories.set(tabId, { history: [], index: -1 });

      const tabEl = document.createElement('div');
      tabEl.className = 'tab';
      tabEl.dataset.tabId = tabId;
      tabEl.innerHTML = `<span>${tab.title}</span><button class="tab-close">&times;</button>`;
      tabEl.addEventListener('click', (e) => {
        if (!e.target.classList.contains('tab-close')) setActiveTab(tabId);
      });
      tabEl.querySelector('.tab-close').addEventListener('click', (e) => {
        e.stopPropagation();
        closeTab(tabId);
      });
      tabsContainer.appendChild(tabEl);

      setActiveTab(tabId);
      if (url) navigateToUrl(url, tab);
    }

    function setActiveTab(tabId) {
      const tab = tabs.find(t => t.id === tabId);
      if (!tab) return;
      document.querySelectorAll('.tab').forEach(el => el.classList.toggle('active', el.dataset.tabId === tabId));
      tabs.forEach(t => { if (t.iframe) t.iframe.style.display = t.id === tabId ? 'block' : 'none'; });
      addressBar.value = tab.url || '';
      activeTabId = tabId;
    }

    function closeTab(tabId) {
      if (tabs.length <= 1) return;
      const i = tabs.findIndex(t => t.id === tabId);
      if (i === -1) return;
      const tab = tabs[i];
      if (tab.iframe) tab.iframe.remove();
      document.querySelector(`.tab[data-tab-id="${tabId}"]`)?.remove();
      tabs.splice(i, 1);
      if (activeTabId === tabId) setActiveTab(tabs[Math.max(0, i - 1)].id);
    }

    function getActiveTab() { return tabs.find(t => t.id === activeTabId); }

    function navigateHistory(dir) {
      const tab = getActiveTab();
      if (!tab) return;
      const history = tabHistories.get(tab.id);
      if (!history) return;
      history.index += dir;
      if (history.index >= 0 && history.index < history.history.length) {
        navigateToUrl(history.history[history.index], tab, true);
      }
    }

    function navigateToUrl(input, tab, fromHistory = false) {
      if (!tab) return;
      const proxiedUrl = encodeUrl(input);
      if (!fromHistory) {
        const history = tabHistories.get(tab.id);
        history.history.push(input);
        history.index = history.history.length - 1;
      }
      tab.url = input;
      addressBar.value = input;
      if (!tab.iframe) {
        tab.iframe = document.createElement('iframe');
        tab.iframe.className = 'webview active';
        webviewContainer.appendChild(tab.iframe);
      }
      showLoading();
      tab.iframe.src = proxiedUrl;
      tab.iframe.onload = () => hideLoading();
    }

    function showLoading() { loadingIndicator.style.display = 'flex'; }
    function hideLoading() { loadingIndicator.style.display = 'none'; }

    init();
  </script>
</body>
</html>
